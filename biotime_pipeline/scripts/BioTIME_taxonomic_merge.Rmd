---
title: "BioTIME Taxonomy Matching"
author: "Eli Duggan"
date: "2025-06-20"
output: html_document
---

# Import packages
```{r setup, include=FALSE}
pkgs <- c("dplyr")
to_install <- pkgs[!pkgs %in% rownames(installed.packages())]
if (length(to_install)) install.packages(to_install)

library(dplyr)
```

# Load datasets: raw BioTIME, entries with valid_name resolved, entries with taxonomic classification
```{r}
# Load data
classified <- read.csv("../data/classified_species.csv")
resolved <- read.csv("../data/biotime_resolved_entries.csv")
load("../data/biotime_data.RData")  # loads biotime_data
```

# normalize keys for matching
```{r}
classified <- classified %>%
  mutate(genus_species = trimws(tolower(genus_species)))

resolved <- resolved %>%
  mutate(resolved_name = tolower(trimws(resolved_name)),
         valid_name = tolower(trimws(valid_name)))

biotime_data <- biotime_data %>%
  mutate(valid_name = tolower(trimws(valid_name)))

# # DEBUG 1 - how many resolved names match classified?
# resolved_matches <- resolved %>%
#   filter(resolved_name %in% classified$genus_species)
# 
# cat("Resolved names matched with classified species:", nrow(resolved_matches), "\n")
```

# Join classified taxonomy + resolved entries by scientific name
```{r}
resolved_taxonomy <- resolved %>%
  select(-resolution_method) %>%  # drop unnecessary column
  left_join(classified, by = c("resolved_name" = "genus_species"))

# # DEBUG 2 - how many resolved entries have assigned taxonomy?
# cat("Resolved entries with taxonomy:\n")
# print(colSums(!is.na(resolved_taxonomy[, c("phylum", "class", "order")])))
```

# Join taxonomy into BioTIME by valid_name
```{r}
biotime_taxonomy <- biotime_data %>%
  left_join(resolved_taxonomy, by = "valid_name")

# # DEBUG 3 - how many BioTIME entries have taxonomy?
# cat("BioTIME records with taxonomy:\n")
# print(colSums(!is.na(biotime_taxonomy[, c("phylum", "class", "order")])))
```

# Save output files
```{r}
save(biotime_taxonomy, file = "../data/biotime_taxonomic_assignment.RData")

biotime_taxonomy %>%
  filter(!is.na(class)) %>%
  write.csv("../data/biotime_taxonomic_assignment.csv", row.names = FALSE)
```