---
title: "Database Filtering and Taxonomic Classification"
author: "Eli Duggan"
date: "2025-06-14"
output: html_notebook
---

# 1. Load packages
```{r setup, include=FALSE}
pkgs <- c("dplyr", "stringr", "readr", "purrr", "stringdist", "fuzzyjoin", "taxize", "vroom")
to_install <- pkgs[!pkgs %in% rownames(installed.packages())]
if (length(to_install)) install.packages(to_install)

library(dplyr)
library(stringr)
library(readr)
library(purrr)
library(stringdist)
library(fuzzyjoin)
library(taxize)
library(vroom)
```

# 2. Load data
```{r}
# Load BioTIME data
load("../data/biotime_data.RData")

# Load GBIF Taxon.tsv for GBIF species list
gbif_file <- "../data/Taxon.tsv"
gbif_data <- read_tsv(gbif_file, show_col_types = FALSE)

# Build full GBIF species binomial list
gbif_species <- gbif_data %>%
  filter(taxonRank == "species", !is.na(genus), !is.na(specificEpithet)) %>%
  mutate(full_binomial = paste(genus, specificEpithet)) %>%
  distinct(full_binomial)
```

# 3. Define helper functions

### Filter unusable data function
```{r}
filter_species <- function(df, species_column = "valid_name") {
  
  original_count <- nrow(df)
  
  remove_resolutions <- c("phylum", "subphylum", "superclass", "kingdom")
  df_clean <- df %>%
    filter(!is.na(!!sym(species_column)),
           !str_detect(!!sym(species_column), regex("morphospecies|unidentif|unknown|undetermined", ignore_case = TRUE)),
           !tolower(resolution) %in% remove_resolutions,
           !str_detect(!!sym(species_column), regex("\\s(sp|spp|sp\\d+)\\.?$", ignore_case = TRUE)))
  
  kept_count <- nrow(df_clean)
  removed_count <- original_count - kept_count
  removed_pct <- round((removed_count / original_count) * 100, 2)
  
  cat("Original rows:", original_count, "\n")
  cat("Rows removed:", removed_count, "\n")
  cat("Rows kept:", kept_count, "\n")
  cat("Percentage removed:", removed_pct, "%\n")
  return(df_clean)
}
```

### Bird name resolution function
```{r}
resolve_bird_names <- function(df, species_column = "resolved_name", bird_lookup_path = "../data/IBP-AOS-LIST24.csv") {
  
  bird_df <- vroom(bird_lookup_path, show_col_types = FALSE) %>%
    mutate(four_code = toupper(SPEC), six_code = toupper(SPEC6),
           common_clean = tolower(gsub("[^a-z]", "", COMMONNAME)),
           scientific_name = str_trim(SCINAME))
  
  df <- df %>% mutate(input_upper = toupper(.data[[species_column]]),
                      input_clean = tolower(gsub("[^a-z]", "", .data[[species_column]])))
  
  # 4-letter match
  df <- df %>%
    left_join(bird_df %>% select(four_code, scientific_name), by = c("input_upper" = "four_code")) %>%
    mutate(resolved_name = ifelse(!is.na(scientific_name) & is.na(how_resolved), scientific_name, .data[[species_column]]),
           how_resolved = ifelse(!is.na(scientific_name) & is.na(how_resolved), "bird_4letter", how_resolved)) %>%
    select(-scientific_name)

  # 6-letter match
  df <- df %>%
    left_join(bird_df %>% select(six_code, scientific_name), by = c("input_upper" = "six_code")) %>%
    mutate(resolved_name = ifelse(!is.na(scientific_name) & is.na(how_resolved), scientific_name, resolved_name),
           how_resolved = ifelse(!is.na(scientific_name) & is.na(how_resolved), "bird_6letter", how_resolved)) %>%
    select(-scientific_name)

  # common name match
  df <- df %>%
    left_join(bird_df %>% select(common_clean, scientific_name), by = c("input_clean" = "common_clean")) %>%
    mutate(resolved_name = ifelse(!is.na(scientific_name) & is.na(how_resolved), scientific_name, resolved_name),
           how_resolved = ifelse(!is.na(scientific_name) & is.na(how_resolved), "bird_common", how_resolved)) %>%
    select(-scientific_name, -input_upper, -input_clean)
  
  return(df)
}
```

### Plant code resolution function
```{r}
decode_plant_codes <- function(df, species_column = "resolved_name", plant_lookup_path = "../data/plant_code_lookup.csv") {
  
  plant_lookup <- vroom(plant_lookup_path, show_col_types = FALSE)
  
  # identify plant code candidates
  df <- df %>% mutate(code = ifelse(nchar(.data[[species_column]]) %in% c(7,8) & grepl("^[A-Z]+$", .data[[species_column]]), .data[[species_column]], NA_character_))

  #### Helper function for safe joins
  safe_join <- function(df_left, df_right, by_col, code_type) {
    joined <- df_left %>%
      left_join(df_right, by = by_col, suffix = c("", ".lookup")) %>%
      mutate(resolved_name = ifelse(!is.na(plant_binomial) & is.na(how_resolved), plant_binomial, resolved_name),
             how_resolved = ifelse(!is.na(plant_binomial) & is.na(how_resolved), code_type, how_resolved)) %>%
      select(-plant_binomial)
    return(joined)
  }

  ## STEP 1: Exact 8-character match
  df <- safe_join(df, plant_lookup, by = c("code" = "code8"), code_type = "plant_code_lookup_8char")
  
  ## STEP 2: Exact 7-character 3+4 match (only on unresolved rows)
  unmatched <- df %>% filter(is.na(how_resolved) & !is.na(code))
  if (nrow(unmatched) > 0) {
    unmatched <- safe_join(unmatched, plant_lookup, by = c("code" = "code7_3_4"), code_type = "plant_code_lookup_7char_3_4")
    df <- df %>% filter(!is.na(how_resolved) | is.na(code)) %>% bind_rows(unmatched)
  }
  
  ## STEP 3: Exact 7-character 4+3 match (only remaining unmatched rows)
  unmatched <- df %>% filter(is.na(how_resolved) & !is.na(code))
  if (nrow(unmatched) > 0) {
    unmatched <- safe_join(unmatched, plant_lookup, by = c("code" = "code7_4_3"), code_type = "plant_code_lookup_7char_4_3")
    df <- df %>% filter(!is.na(how_resolved) | is.na(code)) %>% bind_rows(unmatched)
  }

  ## STEP 4: Fuzzy matching step
  unmatched <- df %>% filter(is.na(how_resolved) & !is.na(code))
  if (nrow(unmatched) > 0) {
    fuzzy_result <- stringdist_left_join(
      unmatched, 
      plant_lookup %>% select(code8, plant_binomial),
      by = c("code" = "code8"),
      max_dist = 1,
      distance_col = "dist"
    ) %>%
    mutate(
      resolved_name = ifelse(!is.na(plant_binomial) & is.na(how_resolved), plant_binomial, resolved_name),
      how_resolved = ifelse(!is.na(plant_binomial) & is.na(how_resolved), "plant_code_lookup_fuzzy8", how_resolved)
    ) %>%
    select(-plant_binomial, -dist)
    
    df <- df %>% filter(!is.na(how_resolved) | is.na(code)) %>% bind_rows(fuzzy_result)
  }

  df <- df %>% select(-code)
  return(df)
}
```

### Spellcheck function
```{r}
spellcheck_species_names <- function(df, species_column = "resolved_name", max_dist = 2) {
  set.seed(8)
  name_vector <- unique(na.omit(df[[species_column]]))

  col_results <- purrr::map_df(name_vector, function(name) {
    tryCatch({
      res <- taxize::col_search(name, limit = 1)
      if (nrow(res) > 0) {
        tibble::tibble(input_name = name, col_canonical = res$name, col_id = res$id)
      } else {
        tibble::tibble(input_name = name, col_canonical = NA_character_, col_id = NA)
      }
    }, error = function(e) {
      tibble::tibble(input_name = name, col_canonical = NA_character_, col_id = NA)
    })
  })

  unresolved <- col_results %>% dplyr::filter(is.na(col_canonical))
  resolved <- col_results %>% dplyr::filter(!is.na(col_canonical))

  if (nrow(unresolved) > 0 & nrow(resolved) > 0) {
    fuzzy <- fuzzyjoin::stringdist_left_join(
      unresolved,
      resolved,
      by = c("input_name" = "col_canonical"),
      max_dist = max_dist,
      distance_col = "dist"
    ) %>%
      dplyr::group_by(input_name) %>%
      dplyr::slice_min(dist, n = 1, with_ties = FALSE) %>%
      dplyr::ungroup() %>%
      dplyr::mutate(final_name = dplyr::coalesce(col_canonical.y, input_name))
  } else {
    fuzzy <- unresolved %>% dplyr::mutate(final_name = input_name)
  }

  all_resolved <- dplyr::bind_rows(
    resolved %>% dplyr::mutate(final_name = col_canonical),
    fuzzy %>% dplyr::select(input_name, final_name)
  )

  df <- df %>%
    dplyr::left_join(all_resolved, by = setNames("input_name", species_column)) %>%
    dplyr::mutate(
      was_updated = !is.na(final_name) & final_name != .data[[species_column]],
      resolved_name = ifelse(was_updated & is.na(how_resolved), final_name, .data[[species_column]]),
      how_resolved = ifelse(was_updated & is.na(how_resolved), "spellcheck", how_resolved)
    ) %>%
    dplyr::select(-final_name, -was_updated, -col_canonical, -col_id)

  return(df)
}
```

### Wrapping function to resolve all names
```{r}
resolve_species_names <- function(df, species_column = "resolved_name", bird_lookup_path = "../data/IBP-AOS-LIST24.csv") {
  cat("Starting species name resolution pipeline.\n")
  
  unresolved <- df %>% filter(is.na(how_resolved))
  resolved <- df %>% filter(!is.na(how_resolved))

  if (nrow(unresolved) > 0) {
    cat("- Resolving bird names\n")
    unresolved <- resolve_bird_names(unresolved, species_column = species_column, bird_lookup_path = bird_lookup_path)

    cat("- Resolving plant codes\n")
    unresolved <- decode_plant_codes(unresolved, species_column = species_column)

    cat("- Spellchecking remaining names\n")
    unresolved <- spellcheck_species_names(unresolved, species_column = species_column)
  }

  df_final <- bind_rows(resolved, unresolved)
  cat("Species name resolution complete.\n")
  return(df_final)
}
```

# 4. Filtering and species resolution pipeline
```{r}
filtered_data <- filter_species(biotime_data)
# Removed 2.17% of rows with all filters applied (259,905/11,989,233)

# Pre-tag already-valid species
filtered_data <- filtered_data %>%
  mutate(
    resolved_name = valid_name,
    how_resolved = ifelse(valid_name %in% gbif_species$full_binomial, 
                          "already_valid_gbif", 
                          NA_character_))

resolved_data <- resolve_species_names(filtered_data, species_column = "resolved_name")
```

# 5. Diagnostics
```{r}
species_resolution_diagnostics <- function(resolved_data) {
  total_rows <- nrow(resolved_data)
  unresolved_rows <- sum(is.na(resolved_data$how_resolved))
  method_counts <- resolved_data %>% count(how_resolved, sort = TRUE)

  cat("\n--- Species Name Resolution Summary ---\n")
  cat("Total rows:", total_rows, "\n")
  cat("Unresolved rows:", unresolved_rows, "\n")
  print(method_counts)
}

species_resolution_diagnostics(resolved_data)
```

# 6. Export outputs
```{r}
unique_genus_species <- resolved_data %>%
  filter(!is.na(resolved_name)) %>%
  filter(str_count(resolved_name, "\\s+") >= 1) %>%
  mutate(GENUS = word(resolved_name, 1),
         SPECIES = word(resolved_name, 2),
         GENUS_SPECIES = paste(GENUS, SPECIES)) %>%
  distinct(GENUS_SPECIES, .keep_all = TRUE) %>%
  arrange(GENUS, SPECIES) %>%
  mutate(NUMBER = row_number()) %>%
  select(NUMBER, GENUS, SPECIES, GENUS_SPECIES)

write_csv(resolved_data, "../data/filtered_resolved_biotimes.csv")
write_csv(unique_genus_species, "../data/unique_genus_species_biotime.csv")
```